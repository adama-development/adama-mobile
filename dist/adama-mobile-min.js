"use strict";angular.module("adama-mobile",["ionic","ionic.service.core","ionic.service.auth","ionic.service.deploy","ionic.service.push","pascalprecht.translate","ngCookies","ngResource","LocalStorageModule","ngCordova","angular-jwt","ngMessages"]),angular.module("adama-mobile").run(["$ionicPlatform",function(e){e.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),cordova.plugins.Keyboard.disableScroll(!0)),window.StatusBar&&StatusBar.styleDefault()})}]),angular.module("adama-mobile").config(["$urlRouterProvider",function(e){e.otherwise(function(e){var t=e.get("$state");t.go("app.main")})}]),angular.module("adama-mobile").config(["$translateProvider",function(e){e.useSanitizeValueStrategy("escapeParameters"),e.useLocalStorage(),e.registerAvailableLanguageKeys(["en","fr"],{"en_*":"en","fr_*":"fr"}),e.determinePreferredLanguage().fallbackLanguage("en")}]),angular.module("adama-mobile").config(["$stateProvider","adamaConstant",function(e,t){e.state("app",{"abstract":!0,url:"/app",templateUrl:function(){return t.adamaMobileToolkitTemplateUrl.app}})}]),angular.module("adama-mobile").run(["$rootScope","pageTitle",function(e,t){e.$on("$stateChangeSuccess",function(e,n){n&&n.data&&n.data.pageTitle&&t.set(n.data.pageTitle)})}]),angular.module("adama-mobile").config(["$httpProvider",function(e){e.interceptors.push("authExpiredInterceptor"),e.interceptors.push("authInterceptor")}]),angular.module("adama-mobile").run(["$rootScope","$state","principalService",function(e,t,n){e.$on("$stateChangeStart",function(e,a){a.data&&a.data.authorities&&a.data.authorities.length>0&&(n.isAuthenticated()?n.hasAnyAuthority(a.data.authorities)||t.go("auth.accessDenied"):t.go("auth.signin"))})}]),angular.module("adama-mobile").run(["$rootScope",function(e){e.$on("$stateChangeError",function(e,t,n,a,r,o){throw o})}]),angular.module("adama-mobile").run(["$rootScope","$injector","adamaConstant",function(e,t,n){var a,r;n.enableBadge&&(a=t.get("$ionicPlatform"),r=t.get("$cordovaBadge"),a.on("resume",function(){r.clear()}),a.ready(function(){r.clear()}))}]),angular.module("adama-mobile").run(["$rootScope","$injector","adamaConstant",function(e,t,n){var a,r,o;n.enablePush&&(a=t.get("$ionicPlatform"),r=t.get("$ionicPush"),o=t.get("$ionicUser"),a.ready(function(){r.init({debug:!1,onNotification:function(t){e.$apply(function(){var n=r.getPayload(t);console.log("notification, payload",t,n),e.notification=t,e.payload=n,(t.app.asleep||t.app.closed)&&console.log("application was asleep or closed")})},onRegister:function(e){console.log("Device token",e.token)},canShowAlert:!1,canSetBadge:!0,canPlaySound:!0,canRunActionsOnWake:!0}),o.current().isAuthenticated()?r.register(function(e){console.log("register at startup ok",e)}):r.unregister()}),e.$on("ionicuser-new",function(){r.register(function(e){console.log("register after signing in ok",e)})}),e.$on("principal-remove",function(){r.unregister()}))}]),angular.module("adama-mobile").controller("AccessDeniedCtrl",function(){}),angular.module("adama-mobile").config(["$stateProvider","adamaConstant",function(e,t){e.state("auth",{"abstract":!0,url:"/auth",template:"<ui-view></ui-view>"}),e.state("auth.signin",{url:"/",templateUrl:function(){return t.adamaMobileToolkitTemplateUrl.authSignin},controller:"SigninCtrl",controllerAs:"$ctrl",data:{pageTitle:"SIGNIN",authorities:[]}}),e.state("auth.recoverPassword",{url:"/recoverPassword",templateUrl:function(){return t.adamaMobileToolkitTemplateUrl.authRecover},controller:"RecoverPasswordCtrl",controllerAs:"$ctrl",data:{pageTitle:"RECOVER",authorities:[]}}),e.state("auth.accessDenied",{url:"/accessDenied",templateUrl:function(){return t.adamaMobileToolkitTemplateUrl.authAccessDenied},controller:"AccessDeniedCtrl",controllerAs:"$ctrl",data:{pageTitle:"ACCESS_DENIED",authorities:[]}})}]),angular.module("adama-mobile").config(["$translateProvider",function(e){e.translations("fr",{SIGNIN:"Identification",SIGNIN_INTRO:"Identifiez-vous pour démarrer votre session",SIGNIN_FORGET_PASSWORD:"J'ai oublié mon mot de passe ...",SIGNIN_USERNAME:"Identifiant",SIGNIN_USERNAME_REQUIRED:"L'identifiant est obligatoire",SIGNIN_PASSWORD:"Mot de passe",SIGNIN_PASSWORD_REQUIRED:"Le mot de passe est obligatoire",SIGNIN_SUBMIT:"Démarrer la session",SIGNIN_LOADING:"Données en cours de chargement",SIGNIN_ERROR_TITLE:"Erreur d'authentification",SIGNIN_ERROR_MESSAGE:"Identifiant ou mot de passe incorrect.",RECOVER:"Récupération de mot de passe",RECOVER_INTRO:"Saisissez votre email pour récupérer votre mot de passe",RECOVER_MAIL:"Email",RECOVER_MAIL_REQUIRED:"L'email est obligatoire",RECOVER_MAIL_EMAIL:"L'email n'est pas au bon format",RECOVER_SUBMIT:"Récupérer mon mot de passe",RECOVER_BACK_TO_LOGIN:"Retour à l'identificaition",RECOVER_SUCCESS:"Consultez votre email pour connaître comment réinitialiser votre mot de passe.",RECOVER_ERROR_TITLE:"Erreur",RECOVER_ERROR_GENERIC:"Erreur lors de la récupération du mot de passe.",RECOVER_ERROR_EMAIL_NOT_EXIST:"L'email n'existe pas",ACCESS_DENIED_BACK_TO_HOME:"Retour à l'accueil",ACCESS_DENIED:"Accès interdit",ACCESS_DENIED_INTRO:"Vous n'avez pas suffisamment de droits d'accéder à cette page."}),e.translations("en",{SIGNIN:"Signin",SIGNIN_INTRO:"Sign in to start your session",SIGNIN_FORGET_PASSWORD:"I forgot my password ...",SIGNIN_USERNAME:"Username",SIGNIN_USERNAME_REQUIRED:"Username is required",SIGNIN_PASSWORD:"Password",SIGNIN_PASSWORD_REQUIRED:"Password is required",SIGNIN_SUBMIT:"Start session",SIGNIN_LOADING:"Loading user informations",SIGNIN_ERROR_TITLE:"Authentication error",SIGNIN_ERROR_MESSAGE:"Username or password are incorrect.",RECOVER:"Recover password",RECOVER_INTRO:"Set your email to recover your password",RECOVER_MAIL:"Email",RECOVER_MAIL_REQUIRED:"Email is required",RECOVER_MAIL_EMAIL:"Email does not respect the right format",RECOVER_SUBMIT:"Retrieve my password",RECOVER_BACK_TO_LOGIN:"Back to signin",RECOVER_SUCCESS:"Check your e-mails for details on how to reset your password.",RECOVER_ERROR_TITLE:"Error",RECOVER_ERROR_GENERIC:"Recovering error.",RECOVER_ERROR_EMAIL_NOT_EXIST:"E-Mail address isn't registered! Please check and try again",ACCESS_DENIED_BACK_TO_HOME:"Back to home",ACCESS_DENIED:"Access denied",ACCESS_DENIED_INTRO:"You do not have enough privileges to access this page."})}]),angular.module("adama-mobile").controller("RecoverPasswordCtrl",["$filter","$ionicPopup","principalService",function(e,t,n){var a=this;a.recover=function(r){a.recoverSuccess=!1,a.recoverError=!1,a.errorEmailNotExists=!1,a.loading=!0,n.resetPasswordInit(r).then(function(){a.recoverSuccess=!0})["catch"](function(n){var a="RECOVER_ERROR_GENERIC";400===n.status&&"e-mail address not registered"===n.data&&(a="RECOVER_ERROR_EMAIL_NOT_EXIST");var r=e("translate");t.alert({title:r("RECOVER_ERROR_TITLE"),template:r(a)})})["finally"](function(){a.loading=!1})}}]),angular.module("adama-mobile").controller("SigninCtrl",["$rootScope","$state","authService","$filter","$ionicPopup",function(e,t,n,a,r){var o=this;o.loading=!1,o.signin=function(e,i){o.loading=!0,n.login(e,i).then(function(){console.log("user is logged, rediret to app.main"),t.go("app.main"),o.loading=!1})["catch"](function(e){console.error("error while signing in",e),o.rejection=e;var t=a("translate");r.alert({title:t("SIGNIN_ERROR_TITLE"),template:t("SIGNIN_ERROR_MESSAGE")}),o.loading=!1})}}]),angular.module("adama-mobile").directive("dsBinaryFileUrl",["$parse","binaryFileService",function(e,t){return{scope:!1,link:function(n,a,r){var o=function(a){r.output&&(a=angular.copy(a)),angular.isArray(a)||(a=[a]),t.initUrlForBinaryFiles(a).then(function(){r.output&&e(r.output).assign(n,a)})};n.$watch(r.input,function(){var t=e(r.input)(n);t&&o(t)})}}}]),angular.module("adama-mobile").directive("dsLanguage",["$parse","language",function(e,t){return{scope:!1,link:function(n,a,r){t.getAll().then(function(t){e(r.data).assign(n,t)})}}}]),angular.module("adama-mobile").directive("dsPrincipalIdentity",["$rootScope","$parse","principalService",function(e,t,n){return{scope:!1,link:function(a,r,o){e.$on("principal-new",function(e,n){t(o.data).assign(a,n.principal)}),e.$on("principal-remove",function(){t(o.data).assign(a,void 0)}),n.getPrincipal().then(function(e){t(o.data).assign(a,e)})}}}]),angular.module("adama-mobile").config(["$translateProvider",function(e){e.translations("fr",{BTN_SIGNOUT:"Déconnexion"}),e.translations("en",{BTN_SIGNOUT:"Sign out"})}]),angular.module("adama-mobile").component("btnSignout",{templateUrl:"adama-mobile/btn-signout/btn-signout.html",controller:["authService","$state",function(e,t){var n=this;n.signout=function(){e.logout(),t.go("auth.signin")}}]}),angular.module("adama-mobile").factory("authExpiredInterceptor",["$injector","$q","adamaConstant",function(e,t,n){var a=function(){var t;return function(){return t||(t=e.get("$http"))}}(),r=function(){var t;return function(){return t||(t=e.get("adamaTokenService"))}}(),o=function(){var t;return function(){return t||(t=e.get("$state"))}}();return{responseError:function(e){var i=e.config;return 401===e.status&&0===i.url.indexOf(n.apiBase)?(console.log("authExpiredInterceptor error 401, refresh token",i.url),r().refreshAndGetToken().then(function(){return console.log("authExpiredInterceptor token is refresh, reset Authorization header"),i.headers.Authorization=void 0,a()(i)},function(e){return o().go("auth.signin").then(function(){return console.log("authExpiredInterceptor error while getting user token",e),t.reject(e)})})):t.reject(e)}}}]),angular.module("adama-mobile").factory("authInterceptor",["$injector","$q","adamaConstant",function(e,t,n){var a=function(){var t;return function(){return t||(t=e.get("adamaTokenService"))}}(),r=function(){var t;return function(){return t||(t=e.get("$state"))}}();return{request:function(e){return console.log("authInterceptor",e.url),e.headers=e.headers||{},e.headers.Authorization||0!==e.url.indexOf(n.apiBase)?e:(console.log("authInterceptor need authorization, getting token"),a().getToken().then(function(t){return console.log("authInterceptor adding Authorization header",t),t&&(e.headers.Authorization="Bearer "+t),e},function(e){return r().go("auth.signin").then(function(){return console.log("authInterceptor error while getting user token",e),t.reject(e)})}))}}}]),angular.module("adama-mobile").factory("User",["$resource","adamaConstant","adamaResourceConfig",function(e,t,n){var a=angular.extend({},n,{"delete":{method:"DELETE",params:{id:"@id"}}});return e(t.apiBase+"users/:id",{},a)}]),angular.module("adama-mobile").factory("adamaResourceConfig",["ParseLinks",function(e){return{query:{method:"GET",isArray:!0,transformResponse:function(t,n,a){return t=angular.fromJson(t),200===a&&(t.$metadata={links:e.parse(n("link")),totalItems:n("X-Total-Count")}),t},interceptor:{response:function(e){return e.resource.$metadata=e.data.$metadata,e.resource}}},get:{method:"GET"},save:{method:"POST"},update:{method:"PUT"},"delete":{method:"DELETE",params:{id:"@id"}}}}]),angular.module("adama-mobile").factory("adamaTokenService",["$rootScope","$http","$q","$state","$ionicUser","jwtHelper","adamaConstant",function(e,t,n,a,r,o,i){var s={},u=r.current();return e.$on("ionicuser-new",function(){console.log("adamaTokenService update ionicUser"),u=r.current()}),s.getToken=function(){console.log("adamaTokenService.getToken");var e;return u.isAuthenticated()&&(console.log("adamaTokenService.getToken user is authenticated"),e=u.get("access_token"),e&&o.isTokenExpired(e))?(console.log("adamaTokenService.getToken token is expired"),s.refreshAndGetToken()):n.when(e)},s.refreshAndGetToken=function(){console.log("adamaTokenService.refreshAndGetToken");var e=u.get("access_token");if(!e)return console.error("no token, redirect to signin"),console.log("for debugging purpose, here is the ionic current user",u),console.log("for debugging purpose, here is the ionic current user.isAuthenticated",u.isAuthenticated()),console.log("for debugging purpose, here is a JSON.stringify version of ionic current user",JSON.stringify(u)),n.reject("refreshAndGetToken : no token !!!!");console.log("adamaTokenService.refreshAndGetToken token",e);var a=u.get("refresh_token");return console.log("adamaTokenService.refreshAndGetToken refreshToken",a),t({method:"POST",url:i.apiBase+"login/refresh",headers:{Authorization:"Bearer "+e},data:{refresh_token:a}}).then(function(e){var t=e.data.access_token;return console.log("adamaTokenService.refreshAndGetToken newToken",t),u.set("access_token",t),u.save().then(function(){return t})},function(e){return console.error("error while refreshing user token, redirect to signin",e),n.reject(e)})},s}]),angular.module("adama-mobile").constant("adamaConstant",{apiBase:"http://localhost:13337/",adamaMobileToolkitTemplateUrl:{app:"adama-mobile/app.html",authAccessDenied:"adama-mobile/auth/accessDenied.html",authSignin:"adama-mobile/auth/signin.html",authRecover:"adama-mobile/auth/recoverPassword.html"},enableBadge:!1,enablePush:!1,urlResetPassword:"path/to/reset/password?isMobile=true"}),angular.module("adama-mobile").factory("authService",["$rootScope","$http","$ionicAuth","adamaConstant","principalService",function(e,t,n,a,r){var o={};return o.login=function(o,i){console.log("login",o);var s={remember:!0},u={username:o,password:i};return n.login("custom",s,u).then(function(){return console.log("login is ok, ask custom auth server to refresh the user data"),t({method:"POST",url:a.apiBase+"externalLogin/refreshUserExternal",data:{externalId:o}})}).then(function(){return console.log("refreshing custom auth server is ok, ask the backend for the updated user info"),e.$broadcast("ionicuser-new"),r.resetPrincipal()}).then(function(){console.log("user is logged in in both ionic and backend"),e.$broadcast("principal-new")})},o.logout=function(){console.log("logout"),n.logout(),r.deletePrincipal()},o}]),angular.module("adama-mobile").factory("binaryFileService",["$http","$q","adamaConstant",function(e,t,n){var a={};return a.initUrlForBinaryFiles=function(a){var r=[],o=[];return angular.forEach(a,function(e){e&&e.id&&!e.url&&(r.push(e),o.push(e.id))}),o.length?e({method:"PUT",url:n.apiBase+"files",data:angular.toJson(o)}).then(function(e){angular.forEach(r,function(t){t.url=e.data.urlList[t.id]})}):t.when()},a}]),angular.module("adama-mobile").provider("language",function(){var e=["en","fr"],t=[{code:"en",labelKey:"FLAG_EN",cssCLass:"us"},{code:"fr",labelKey:"FLAG_FR",cssCLass:"fr"}];this.setLanguages=function(t){e=t},this.setSelectorData=function(e){t=e},this.$get=["$q","$http","$translate",function(n,a,r){var o={};return o.getCurrent=function(){var e=r.storage().get("NG_TRANSLATE_LANG_KEY");return angular.isUndefined(e)&&(e="en"),n.when(e)},o.getAll=function(){return n.when(e)},o.getSelectorData=function(){return n.when(t)},o}]}),angular.module("adama-mobile").factory("pageTitle",["$rootScope","$filter",function(e,t){var n=t("translate"),a={};return a.set=function(t,a){var r=n(t,a);e.pageTitle=r},a}]),angular.module("adama-mobile").service("ParseLinks",function(){this.parse=function(e){if(0===e.length)throw new Error("input must not be of zero length");var t=e.split(","),n={};return angular.forEach(t,function(e){var t=e.split(";");if(2!==t.length)throw new Error('section could not be split on ";"');var a=t[0].replace(/<(.*)>/,"$1").trim(),r={};a.replace(new RegExp("([^?=&]+)(=([^&]*))?","g"),function(e,t,n,a){r[t]=a});var o=r.page;angular.isString(o)&&(o=parseInt(o));var i=t[1].replace(/rel='(.*)'/,"$1").trim();n[i]=o}),n}}),angular.module("adama-mobile").factory("principalService",["$rootScope","$q","$http","$resource","$state","$ionicUser","adamaConstant",function(e,t,n,a,r,o,i){var s,u={},c=o.current(),l=c.isAuthenticated(),d=a(i.apiBase+"account",{},{}),g=a(i.apiBase+"account/change_password",{},{}),p=a(i.apiBase+"account/reset_password/init",{},{});return u.isAuthenticated=function(){return l},u.resetPrincipal=function(){var a;if(c=o.current(),l=c.isAuthenticated(),console.log("resetPrincipal"),console.log("resetPrincipal ionicUser",c),console.log("resetPrincipal isAuthenticated",l),l){var u=c.details.external_id;u?(s=n({method:"GET",url:i.apiBase+"users/byLogin/"+u}).then(function(t){var n=t.data;return l=!0,e.$broadcast("principal-new",{principal:n}),n}),a=s):(console.error("no external_id, redirect to signin"),a=t.reject("resetPrincipal : no external_id"))}else console.error("user is not authenticated"),a=t.reject("resetPrincipal : not authenticated");return a["catch"](function(e){return console.log("there was a problem while reseting user info, redirect to signin"),l=!1,s=void 0,r.go("auth.signin"),t.reject(e)})},u.getPrincipal=function(){return s?s:u.resetPrincipal()},u.deletePrincipal=function(){l=!1,s=void 0,e.$broadcast("principal-remove")},u.hasAnyAuthority=function(e){return console.log("hasAnyAuthority",e),!0},u.resetPasswordInit=function(e){return console.log("resetPasswordInit",e),p.save({mail:e,urlResetPassword:i.urlResetPassword}).$promise},u.updateAccount=function(n){return console.log("updateAccount",n),d.save(n,function(){e.$emit("principal-update",{principal:n}),s=t.when(n)}).$promise},u.changePassword=function(e){return console.log("changePassword"),g.save({password:e}).$promise},u}]);
//# sourceMappingURL=adama-mobile-min.js.map
