"use strict";angular.module("adama-mobile",["ionic","ionic.service.core","ionic.service.auth","ionic.service.deploy","ionic.service.push","pascalprecht.translate","ngCookies","ngResource","LocalStorageModule","ngCordova","angular-jwt","ngMessages"]),angular.module("adama-mobile").run(["$ionicPlatform",function(e){e.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),cordova.plugins.Keyboard.disableScroll(!0)),window.StatusBar&&StatusBar.styleDefault()})}]),angular.module("adama-mobile").config(["$urlRouterProvider",function(e){e.otherwise(function(e){var a=e.get("$state");a.go("app.main")})}]),angular.module("adama-mobile").config(["$translateProvider",function(e){e.useSanitizeValueStrategy("escapeParameters"),e.useLocalStorage(),e.registerAvailableLanguageKeys(["en","fr"],{"en_*":"en","fr_*":"fr"}),e.determinePreferredLanguage().fallbackLanguage("en")}]),angular.module("adama-mobile").config(["$stateProvider","adamaConstant",function(e,a){e.state("app",{"abstract":!0,url:"/app",templateUrl:function(){return a.adamaMobileToolkitTemplateUrl.app}})}]),angular.module("adama-mobile").run(["$rootScope","pageTitle",function(e,a){e.$on("$stateChangeSuccess",function(e,t){t&&t.data&&t.data.pageTitle&&a.set(t.data.pageTitle)})}]),angular.module("adama-mobile").config(["$httpProvider",function(e){e.interceptors.push("authExpiredInterceptor"),e.interceptors.push("authInterceptor")}]),angular.module("adama-mobile").run(["$rootScope","$state","principalService",function(e,a,t){e.$on("$stateChangeStart",function(e,n){n.data&&n.data.authorities&&n.data.authorities.length>0&&(t.isAuthenticated()?t.hasAnyAuthority(n.data.authorities)||a.go("auth.accessDenied"):a.go("auth.signin"))})}]),angular.module("adama-mobile").run(["$rootScope",function(e){e.$on("$stateChangeError",function(e,a,t,n,r,o){throw o})}]),angular.module("adama-mobile").run(["$rootScope","$injector","adamaConstant",function(e,a,t){var n,r;t.enableBadge&&(n=a.get("$ionicPlatform"),r=a.get("$cordovaBadge"),n.on("resume",function(){r.clear()}),n.ready(function(){r.clear()}))}]),angular.module("adama-mobile").run(["$rootScope","$injector","adamaConstant",function(e,a,t){var n,r,o;t.enablePush&&(n=a.get("$ionicPlatform"),r=a.get("$ionicPush"),o=a.get("$ionicUser"),n.ready(function(){r.init({debug:!1,onNotification:function(a){e.$apply(function(){var t=r.getPayload(a);console.log("notification, payload",a,t),e.notification=a,e.payload=t,(a.app.asleep||a.app.closed)&&console.log("application was asleep or closed")})},onRegister:function(e){console.log("Device token",e.token)},canShowAlert:!1,canSetBadge:!0,canPlaySound:!0,canRunActionsOnWake:!0}),o.current().isAuthenticated()?r.register(function(e){console.log("register at startup ok",e)}):r.unregister()}),e.$on("ionicuser-new",function(){r.register(function(e){console.log("register after signing in ok",e)})}),e.$on("principal-remove",function(){r.unregister()}))}]),angular.module("adama-mobile").controller("AccessDeniedCtrl",function(){}),angular.module("adama-mobile").config(["$stateProvider","adamaConstant",function(e,a){e.state("auth",{"abstract":!0,url:"/auth",template:"<ui-view></ui-view>"}),e.state("auth.signin",{url:"/",templateUrl:function(){return a.adamaMobileToolkitTemplateUrl.authSignin},controller:"SigninCtrl",controllerAs:"$ctrl",data:{pageTitle:"SIGNIN",authorities:[]}}),e.state("auth.recoverPassword",{url:"/recoverPassword",templateUrl:function(){return a.adamaMobileToolkitTemplateUrl.authRecover},controller:"RecoverPasswordCtrl",controllerAs:"$ctrl",data:{pageTitle:"RECOVER",authorities:[]}}),e.state("auth.accessDenied",{url:"/accessDenied",templateUrl:function(){return a.adamaMobileToolkitTemplateUrl.authAccessDenied},controller:"AccessDeniedCtrl",controllerAs:"$ctrl",data:{pageTitle:"ACCESS_DENIED",authorities:[]}})}]),angular.module("adama-mobile").config(["$translateProvider",function(e){e.translations("fr",{SIGNIN:"Identification",SIGNIN_INTRO:"Identifiez-vous pour démarrer votre session",SIGNIN_FORGET_PASSWORD:"J'ai oublié mon mot de passe ...",SIGNIN_USERNAME:"Identifiant",SIGNIN_USERNAME_REQUIRED:"L'identifiant est obligatoire",SIGNIN_PASSWORD:"Mot de passe",SIGNIN_PASSWORD_REQUIRED:"Le mot de passe est obligatoire",SIGNIN_SUBMIT:"Démarrer la session",SIGNIN_LOADING:"Données en cours de chargement",SIGNIN_ERROR_TITLE:"Erreur d'authentification",SIGNIN_ERROR_MESSAGE:"Identifiant ou mot de passe incorrect.",RECOVER:"Récupération de mot de passe",RECOVER_INTRO:"Saisissez votre email pour récupérer votre mot de passe",RECOVER_MAIL:"Email",RECOVER_MAIL_REQUIRED:"L'email est obligatoire",RECOVER_MAIL_EMAIL:"L'email n'est pas au bon format",RECOVER_SUBMIT:"Récupérer mon mot de passe",RECOVER_BACK_TO_LOGIN:"Retour à l'identificaition",RECOVER_SUCCESS:"Consultez votre email pour connaître comment réinitialiser votre mot de passe.",RECOVER_ERROR_TITLE:"Erreur",RECOVER_ERROR_GENERIC:"Erreur lors de la récupération du mot de passe.",RECOVER_ERROR_EMAIL_NOT_EXIST:"L'email n'existe pas",ACCESS_DENIED_BACK_TO_HOME:"Retour à l'accueil",ACCESS_DENIED:"Accès interdit",ACCESS_DENIED_INTRO:"Vous n'avez pas suffisamment de droits d'accéder à cette page."}),e.translations("en",{SIGNIN:"Signin",SIGNIN_INTRO:"Sign in to start your session",SIGNIN_FORGET_PASSWORD:"I forgot my password ...",SIGNIN_USERNAME:"Username",SIGNIN_USERNAME_REQUIRED:"Username is required",SIGNIN_PASSWORD:"Password",SIGNIN_PASSWORD_REQUIRED:"Password is required",SIGNIN_SUBMIT:"Start session",SIGNIN_LOADING:"Loading user informations",SIGNIN_ERROR_TITLE:"Authentication error",SIGNIN_ERROR_MESSAGE:"Username or password are incorrect.",RECOVER:"Recover password",RECOVER_INTRO:"Set your email to recover your password",RECOVER_MAIL:"Email",RECOVER_MAIL_REQUIRED:"Email is required",RECOVER_MAIL_EMAIL:"Email does not respect the right format",RECOVER_SUBMIT:"Retrieve my password",RECOVER_BACK_TO_LOGIN:"Back to signin",RECOVER_SUCCESS:"Check your e-mails for details on how to reset your password.",RECOVER_ERROR_TITLE:"Error",RECOVER_ERROR_GENERIC:"Recovering error.",RECOVER_ERROR_EMAIL_NOT_EXIST:"E-Mail address isn't registered! Please check and try again",ACCESS_DENIED_BACK_TO_HOME:"Back to home",ACCESS_DENIED:"Access denied",ACCESS_DENIED_INTRO:"You do not have enough privileges to access this page."})}]),angular.module("adama-mobile").controller("RecoverPasswordCtrl",["$filter","$ionicPopup","principalService",function(e,a,t){var n=this;n.recover=function(r){n.recoverSuccess=!1,n.recoverError=!1,n.errorEmailNotExists=!1,n.loading=!0,t.resetPasswordInit(r).then(function(){n.recoverSuccess=!0})["catch"](function(t){var n="RECOVER_ERROR_GENERIC";400===t.status&&"e-mail address not registered"===t.data&&(n="RECOVER_ERROR_EMAIL_NOT_EXIST");var r=e("translate");a.alert({title:r("RECOVER_ERROR_TITLE"),template:r(n)})})["finally"](function(){n.loading=!1})}}]),angular.module("adama-mobile").controller("SigninCtrl",["$rootScope","$state","authService","$filter","$ionicPopup",function(e,a,t,n,r){var o=this;o.loading=!1,o.signin=function(e,i){o.loading=!0,t.login(e,i).then(function(){console.log("user is logged in in both ionic and backend, rediret to app.main"),a.go("app.main")})["catch"](function(e){o.rejection=e,console.error("error while signing in",e);var a=n("translate");r.alert({title:a("SIGNIN_ERROR_TITLE"),template:a("SIGNIN_ERROR_MESSAGE")})})["finally"](function(){o.loading=!1})}}]),angular.module("adama-mobile").config(["$translateProvider",function(e){e.translations("fr",{BTN_SIGNOUT:"Déconnexion"}),e.translations("en",{BTN_SIGNOUT:"Sign out"})}]),angular.module("adama-mobile").component("btnSignout",{templateUrl:"adama-mobile/btn-signout/btn-signout.html",controller:["authService","$state",function(e,a){var t=this;t.signout=function(){e.logout(),a.go("auth.signin")}}]}),angular.module("adama-mobile").directive("dsBinaryFileUrl",["$parse","binaryFileService",function(e,a){return{scope:!1,link:function(t,n,r){var o=function(n){r.output&&(n=angular.copy(n)),angular.isArray(n)||(n=[n]),a.initUrlForBinaryFiles(n).then(function(){r.output&&e(r.output).assign(t,n)})};t.$watch(r.input,function(){var a=e(r.input)(t);a&&o(a)})}}}]),angular.module("adama-mobile").directive("dsLanguage",["$parse","language",function(e,a){return{scope:!1,link:function(t,n,r){a.getAll().then(function(a){e(r.data).assign(t,a)})}}}]),angular.module("adama-mobile").directive("dsPrincipalIdentity",["$rootScope","$parse","principalService",function(e,a,t){return{scope:!1,link:function(n,r,o){e.$on("principal-new",function(e,t){a(o.data).assign(n,t.principal)}),e.$on("principal-remove",function(){a(o.data).assign(n,void 0)}),t.getPrincipal().then(function(e){a(o.data).assign(n,e)})}}}]),angular.module("adama-mobile").factory("User",["$resource","adamaConstant","adamaResourceConfig",function(e,a,t){var n=angular.extend({},t,{"delete":{method:"DELETE",params:{login:"@login"}}});return e(a.apiBase+"users/:login",{},n)}]),angular.module("adama-mobile").factory("authExpiredInterceptor",["$injector","$q","adamaConstant",function(e,a,t){var n=function(){var a;return function(){return a||(a=e.get("$http"))}}(),r=function(){var a;return function(){return a||(a=e.get("adamaTokenService"))}}();return{responseError:function(e){var o=e.config;return 401===e.status&&0===o.url.indexOf(t.apiBase)?(console.log("authExpiredInterceptor error 401, refresh token",o.url),r().refreshAndGetToken().then(function(){return console.log("authExpiredInterceptor token is refresh, reset Authorization header"),o.headers.Authorization=void 0,n()(o)})):a.reject(e)}}}]),angular.module("adama-mobile").factory("authInterceptor",["$injector","adamaConstant",function(e,a){var t=function(){var a;return function(){return a||(a=e.get("adamaTokenService"))}}();return{request:function(e){return console.log("authInterceptor",e.url),e.headers=e.headers||{},e.headers.Authorization||0!==e.url.indexOf(a.apiBase)?e:(console.log("authInterceptor need authorization, getting token"),t().getToken().then(function(a){return console.log("authInterceptor adding Authorization header",a),a&&(e.headers.Authorization="Bearer "+a),e}))}}}]),angular.module("adama-mobile").factory("adamaResourceConfig",["ParseLinks",function(e){return{query:{method:"GET",isArray:!0,transformResponse:function(a,t,n){return a=angular.fromJson(a),200===n&&(a.$metadata={links:e.parse(t("link")),totalItems:t("X-Total-Count")}),a},interceptor:{response:function(e){return e.resource.$metadata=e.data.$metadata,e.resource}}},get:{method:"GET"},save:{method:"POST"},update:{method:"PUT"},"delete":{method:"DELETE",params:{id:"@id"}}}}]),angular.module("adama-mobile").factory("adamaTokenService",["$rootScope","$http","$q","$state","$ionicUser","jwtHelper","adamaConstant",function(e,a,t,n,r,o,i){var s={},c=r.current();return e.$on("ionicuser-new",function(){console.log("adamaTokenService update ionicUser"),c=r.current()}),s.getToken=function(){console.log("adamaTokenService.getToken");var e;return c.isAuthenticated()&&(console.log("adamaTokenService.getToken user is authenticated"),e=c.get("access_token"),o.isTokenExpired(e))?(console.log("adamaTokenService.getToken token is expired"),s.refreshAndGetToken()):t.when(e)},s.refreshAndGetToken=function(){console.log("adamaTokenService.refreshAndGetToken");var e=c.get("access_token");if(!e)return console.error("no token, redirect to signin"),n.go("auth.signin"),t.reject("refreshAndGetToken : no token");console.log("adamaTokenService.refreshAndGetToken token",e);var r=c.get("refresh_token");return console.log("adamaTokenService.refreshAndGetToken refreshToken",r),a({method:"POST",url:i.apiBase+"login/refresh",headers:{Authorization:"Bearer "+e},data:{refresh_token:r}}).then(function(e){var a=e.data.access_token;return console.log("adamaTokenService.refreshAndGetToken newToken",a),c.set("access_token",a),c.save().then(function(){return a})},function(e){return console.error("error while refreshing user token, redirect to signin",e),n.go("auth.signin"),t.reject(e)})},s}]),angular.module("adama-mobile").constant("adamaConstant",{apiBase:"http://localhost:13337/",adamaMobileToolkitTemplateUrl:{app:"adama-mobile/app.html",authAccessDenied:"adama-mobile/auth/accessDenied.html",authSignin:"adama-mobile/auth/signin.html",authRecover:"adama-mobile/auth/recoverPassword.html"},enableBadge:!1,enablePush:!1,urlResetPassword:"path/to/reset/password?isMobile=true"}),angular.module("adama-mobile").factory("authService",["$rootScope","$http","$ionicAuth","adamaConstant","principalService",function(e,a,t,n,r){var o={};return o.login=function(o,i){console.log("login",o);var s={remember:!0},c={username:o,password:i};return t.login("custom",s,c).then(function(){return console.log("login is ok, ask custom auth server to refresh the user data"),a({method:"POST",url:n.apiBase+"externalLogin/refreshUserExternal",data:{externalId:o}})}).then(function(){return console.log("refreshing custom auth server is ok, ask the backend for the updated user info"),e.$broadcast("ionicuser-new"),r.resetPrincipal()})},o.logout=function(){console.log("logout"),t.logout(),r.deletePrincipal()},o}]),angular.module("adama-mobile").factory("binaryFileService",["$http","$q","adamaConstant",function(e,a,t){var n={};return n.initUrlForBinaryFiles=function(n){var r=[],o=[];return angular.forEach(n,function(e){e&&e.id&&!e.url&&(r.push(e),o.push(e.id))}),o.length?e({method:"PUT",url:t.apiBase+"files",data:angular.toJson(o)}).then(function(e){angular.forEach(r,function(a){a.url=e.data.urlList[a.id]})}):a.when()},n}]),angular.module("adama-mobile").provider("language",function(){var e=["en","fr"],a=[{code:"en",labelKey:"FLAG_EN",cssCLass:"us"},{code:"fr",labelKey:"FLAG_FR",cssCLass:"fr"}];this.setLanguages=function(a){e=a},this.setSelectorData=function(e){a=e},this.$get=["$q","$http","$translate",function(t,n,r){var o={};return o.getCurrent=function(){var e=r.storage().get("NG_TRANSLATE_LANG_KEY");return angular.isUndefined(e)&&(e="en"),t.when(e)},o.getAll=function(){return t.when(e)},o.getSelectorData=function(){return t.when(a)},o}]}),angular.module("adama-mobile").factory("pageTitle",["$rootScope","$filter",function(e,a){var t=a("translate"),n={};return n.set=function(a){var n=t(a);e.pageTitle=n},n}]),angular.module("adama-mobile").service("ParseLinks",function(){this.parse=function(e){if(0===e.length)throw new Error("input must not be of zero length");var a=e.split(","),t={};return angular.forEach(a,function(e){var a=e.split(";");if(2!==a.length)throw new Error('section could not be split on ";"');var n=a[0].replace(/<(.*)>/,"$1").trim(),r={};n.replace(new RegExp("([^?=&]+)(=([^&]*))?","g"),function(e,a,t,n){r[a]=n});var o=r.page;angular.isString(o)&&(o=parseInt(o));var i=a[1].replace(/rel='(.*)'/,"$1").trim();t[i]=o}),t}}),angular.module("adama-mobile").factory("principalService",["$rootScope","$q","$http","$resource","$state","$ionicUser","adamaConstant",function(e,a,t,n,r,o,i){var s,c={},u=o.current(),l=u.isAuthenticated(),d=n(i.apiBase+"account",{},{}),g=n(i.apiBase+"account/change_password",{},{}),m=n(i.apiBase+"account/reset_password/init",{},{});return c.isAuthenticated=function(){return l},c.resetPrincipal=function(){var n;if(u=o.current(),l=u.isAuthenticated(),console.log("resetPrincipal"),console.log("resetPrincipal ionicUser",u),console.log("resetPrincipal isAuthenticated",l),l){var c=u.details.external_id;c?(s=t({method:"GET",url:i.apiBase+"users/byLogin/"+c}).then(function(a){var t=a.data;return l=!0,e.$broadcast("principal-new",{principal:t}),t}),n=s):(console.error("no external_id, redirect to signin"),n=a.reject("resetPrincipal : no external_id"))}else console.error("user is not authenticated"),n=a.reject("resetPrincipal : not authenticated");return n["catch"](function(e){return console.log("there was a problem while reseting user info, redirect to signin"),l=!1,s=void 0,r.go("auth.signin"),a.reject(e)})},c.getPrincipal=function(){return s?s:c.resetPrincipal()},c.deletePrincipal=function(){l=!1,s=void 0,e.$broadcast("principal-remove")},c.hasAnyAuthority=function(e){return console.log("hasAnyAuthority",e),!0},c.resetPasswordInit=function(e){return console.log("resetPasswordInit",e),m.save({mail:e,urlResetPassword:i.urlResetPassword}).$promise},c.updateAccount=function(t){return console.log("updateAccount",t),d.save(t,function(){e.$emit("principal-update",{principal:t}),s=a.when(t)}).$promise},c.changePassword=function(e){return console.log("changePassword"),g.save({password:e}).$promise},c}]);
//# sourceMappingURL=adama-mobile-min.js.map
