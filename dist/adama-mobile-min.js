"use strict";angular.module("adama-mobile",["ionic","ionic.service.core","ionic.service.auth","ionic.service.deploy","ionic.service.push","pascalprecht.translate","ngCookies","ngResource","LocalStorageModule","ngCordova","angular-jwt","ngMessages"]),angular.module("adama-mobile").run(["$ionicPlatform",function(e){e.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),cordova.plugins.Keyboard.disableScroll(!0)),window.StatusBar&&StatusBar.styleDefault()})}]),angular.module("adama-mobile").config(["$urlRouterProvider",function(e){e.otherwise("/app/")}]),angular.module("adama-mobile").config(["$translateProvider",function(e){e.useSanitizeValueStrategy("escapeParameters"),e.useLocalStorage(),e.registerAvailableLanguageKeys(["en","fr"],{"en_*":"en","fr_*":"fr"}),e.determinePreferredLanguage().fallbackLanguage("en")}]),angular.module("adama-mobile").config(["$stateProvider","adamaConstant",function(e,t){e.state("app",{"abstract":!0,url:"/app",templateUrl:function(){return t.adamaMobileToolkitTemplateUrl.app}})}]),angular.module("adama-mobile").run(["$rootScope","pageTitle",function(e,t){e.$on("$stateChangeSuccess",function(e,a){a&&a.data&&a.data.pageTitle&&t.set(a.data.pageTitle)})}]),angular.module("adama-mobile").config(["$httpProvider",function(e){e.interceptors.push("authExpiredInterceptor"),e.interceptors.push("authInterceptor")}]),angular.module("adama-mobile").run(["$rootScope","$state","principalService",function(e,t,a){e.$on("$stateChangeStart",function(e,r){r.data&&r.data.authorities&&r.data.authorities.length>0&&(a.isAuthenticated()?a.hasAnyAuthority(r.data.authorities)||t.go("auth.accessDenied"):t.go("auth.signin"))})}]),angular.module("adama-mobile").run(["$rootScope",function(e){e.$on("$stateChangeError",function(e,t,a,r,n,o){throw o})}]),angular.module("adama-mobile").run(["$rootScope","$injector","adamaConstant",function(e,t,a){var r,n;a.enableBadge&&(r=t.get("$ionicPlatform"),n=t.get("$cordovaBadge"),r.on("resume",function(){n.clear()}),r.ready(function(){n.clear()}))}]),angular.module("adama-mobile").run(["$rootScope","$injector","adamaConstant",function(e,t,a){var r,n,o;a.enablePush&&(r=t.get("$ionicPlatform"),n=t.get("$ionicPush"),o=t.get("$ionicUser"),r.ready(function(){n.init({debug:!1,onNotification:function(t){e.$apply(function(){var a=n.getPayload(t);console.log("notification, payload",t,a),e.notification=t,e.payload=a,(t.app.asleep||t.app.closed)&&console.log("application was asleep or closed")})},onRegister:function(e){console.log("Device token",e.token)},canShowAlert:!1,canSetBadge:!0,canPlaySound:!0,canRunActionsOnWake:!0}),o.current().isAuthenticated()?n.register(function(e){console.log("register at startup ok",e)}):n.unregister()}),e.on("principal-new",function(){n.register(function(e){console.log("register after signing in ok",e)})}),e.on("principal-remove",function(){n.unregister()}))}]),angular.module("adama-mobile").controller("AccessDeniedCtrl",function(){}),angular.module("adama-mobile").config(["$stateProvider","adamaConstant",function(e,t){e.state("auth",{"abstract":!0,url:"/auth",template:"<ui-view></ui-view>"}),e.state("auth.signin",{url:"/",templateUrl:function(){return t.adamaMobileToolkitTemplateUrl.authSignin},controller:"SigninCtrl",controllerAs:"ctrl",data:{pageTitle:"SIGNIN",authorities:[]}}),e.state("auth.recoverPassword",{url:"/recoverPassword",templateUrl:function(){return t.adamaMobileToolkitTemplateUrl.authRecover},controller:"RecoverPasswordCtrl",controllerAs:"ctrl",data:{pageTitle:"RECOVER",authorities:[]}}),e.state("auth.accessDenied",{url:"/accessDenied",templateUrl:function(){return t.adamaMobileToolkitTemplateUrl.authAccessDenied},controller:"AccessDeniedCtrl",controllerAs:"ctrl",data:{pageTitle:"ACCESS_DENIED",authorities:[]}})}]),angular.module("adama-mobile").config(["$translateProvider",function(e){e.translations("fr",{SIGNIN:"Identification",SIGNIN_INTRO:"Identifiez-vous pour démarrer votre session",SIGNIN_FORGET_PASSWORD:"J'ai oublié mon mot de passe ...",SIGNIN_USERNAME:"Identifiant",SIGNIN_USERNAME_REQUIRED:"L'identifiant est obligatoire",SIGNIN_PASSWORD:"Mot de passe",SIGNIN_PASSWORD_REQUIRED:"Le mot de passe est obligatoire",SIGNIN_SUBMIT:"Démarrer la session",SIGNIN_ERROR_TITLE:"Erreur d'authentification",SIGNIN_ERROR_MESSAGE:"Identifiant ou mot de passe incorrect.",RECOVER:"Récupération de mot de passe",RECOVER_INTRO:"Saisissez votre email pour récupérer votre mot de passe",RECOVER_MAIL:"Email",RECOVER_MAIL_REQUIRED:"L'email est obligatoire",RECOVER_MAIL_EMAIL:"L'email n'est pas au bon format",RECOVER_SUBMIT:"Récupérer mon mot de passe",RECOVER_BACK_TO_LOGIN:"Retour à l'identificaition",RECOVER_SUCCESS:"Consultez votre email pour connaître comment réinitialiser votre mot de passe.",RECOVER_ERROR_TITLE:"Erreur",RECOVER_ERROR_GENERIC:"Erreur lors de la récupération du mot de passe.",RECOVER_ERROR_EMAIL_NOT_EXIST:"L'email n'existe pas",ACCESS_DENIED_BACK_TO_HOME:"Retour à l'accueil",ACCESS_DENIED:"Accès interdit",ACCESS_DENIED_INTRO:"Vous n'avez pas suffisamment de droits d'accéder à cette page."}),e.translations("en",{SIGNIN:"Signin",SIGNIN_INTRO:"Sign in to start your session",SIGNIN_FORGET_PASSWORD:"I forgot my password ...",SIGNIN_USERNAME:"Username",SIGNIN_USERNAME_REQUIRED:"Username is required",SIGNIN_PASSWORD:"Password",SIGNIN_PASSWORD_REQUIRED:"Password is required",SIGNIN_SUBMIT:"Start session",SIGNIN_ERROR_TITLE:"Authentication error",SIGNIN_ERROR_MESSAGE:"Username or password are incorrect.",RECOVER:"Recover password",RECOVER_INTRO:"Set your email to recover your password",RECOVER_MAIL:"Email",RECOVER_MAIL_REQUIRED:"Email is required",RECOVER_MAIL_EMAIL:"Email does not respect the right format",RECOVER_SUBMIT:"Retrieve my password",RECOVER_BACK_TO_LOGIN:"Back to signin",RECOVER_SUCCESS:"Check your e-mails for details on how to reset your password.",RECOVER_ERROR_TITLE:"Error",RECOVER_ERROR_GENERIC:"Recovering error.",RECOVER_ERROR_EMAIL_NOT_EXIST:"E-Mail address isn't registered! Please check and try again",ACCESS_DENIED_BACK_TO_HOME:"Back to home",ACCESS_DENIED:"Access denied",ACCESS_DENIED_INTRO:"You do not have enough privileges to access this page."})}]),angular.module("adama-mobile").controller("RecoverPasswordCtrl",["$filter","$ionicPopup","principalService",function(e,t,a){var r=this;r.recover=function(n){r.recoverSuccess=!1,r.recoverError=!1,r.errorEmailNotExists=!1,r.loading=!0,a.resetPasswordInit(n).then(function(){r.recoverSuccess=!0})["catch"](function(a){var r="RECOVER_ERROR_GENERIC";400===a.status&&"e-mail address not registered"===a.data&&(r="RECOVER_ERROR_EMAIL_NOT_EXIST");var n=e("translate");t.alert({title:n("RECOVER_ERROR_TITLE"),template:n(r)})})["finally"](function(){r.loading=!1})}}]),angular.module("adama-mobile").controller("SigninCtrl",["$rootScope","$state","authService","$filter","$ionicPopup",function(e,t,a,r,n){var o=this;o.signin=function(e,o){a.login(e,o).then(function(){t.go("app.main")})["catch"](function(e){console.error("error while signing in",e);var t=r("translate");n.alert({title:t("SIGNIN_ERROR_TITLE"),template:t("SIGNIN_ERROR_MESSAGE")})})}}]),angular.module("adama-mobile").config(["$translateProvider",function(e){e.translations("fr",{BTN_SIGNOUT:"Déconnexion"}),e.translations("en",{BTN_SIGNOUT:"Sign out"})}]),angular.module("adama-mobile").component("btnSignout",{templateUrl:"adama-mobile/btn-signout/btn-signout.html",controller:["authService","$state",function(e,t){var a=this;a.signout=function(){e.logout(),t.go("auth.signin")}}]}),angular.module("adama-mobile").directive("dsBinaryFileUrl",["$parse","binaryFileService",function(e,t){return{scope:!1,link:function(a,r,n){var o=function(r){n.output&&(r=angular.copy(r)),angular.isArray(r)||(r=[r]),t.initUrlForBinaryFiles(r).then(function(){n.output&&e(n.output).assign(a,r)})};a.$watch(n.input,function(){var t=e(n.input)(a);t&&o(t)})}}}]),angular.module("adama-mobile").directive("dsLanguage",["$parse","language",function(e,t){return{scope:!1,link:function(a,r,n){t.getAll().then(function(t){e(n.data).assign(a,t)})}}}]),angular.module("adama-mobile").directive("dsPrincipalIdentity",["$parse","principalService",function(e,t){return{scope:!1,link:function(a,r,n){t.getPrincipal().then(function(t){e(n.data).assign(a,t)})}}}]),angular.module("adama-mobile").factory("authExpiredInterceptor",["$injector","$q","adamaConstant",function(e,t,a){var r=function(){var t;return function(){return t||(t=e.get("$http"))}}(),n=function(){var t;return function(){return t||(t=e.get("adamaTokenService"))}}();return{responseError:function(e){var o=e.config;return 401===e.status&&0===o.url.indexOf(a.apiBase)?n().refreshAndGetToken().then(function(){return r()(o)}):t.reject(e)}}}]),angular.module("adama-mobile").factory("authInterceptor",["$injector","adamaConstant",function(e,t){var a=function(){var t;return function(){return t||(t=e.get("adamaTokenService"))}}();return{request:function(e){return e.headers=e.headers||{},e.headers["x-auth-token"]||0!==e.url.indexOf(t.apiBase)?e:a().getToken().then(function(t){return t&&(e.headers.Authorization="Bearer "+t),e})}}}]),angular.module("adama-mobile").directive("jhAlert",["AlertService",function(e){return{restrict:"E",template:'<div class="content-wrapper" ng-cloak ng-if="alerts && alerts.length"><div class="box-body"><div ng-repeat="alert in alerts" class="alert alert-dismissible" ng-class="\'alert-\' + alert.type"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>{{ alert.msg }}</div></div></div>',controller:["$scope",function(t){t.alerts=e.get(),t.$on("$destroy",function(){t.alerts=[]})}]}}]).directive("jhAlertError",["AlertService","$rootScope","$translate",function(e,t,a){return{restrict:"E",template:'<div class="alerts" ng-if="alerts && alerts.length"><div ng-repeat="alert in alerts" class="alert alert-dismissible" ng-class="\'alert-\' + alert.type"><button type="button" class="close" data-dismiss="alert" aria-hidden="true">×</button>{{ alert.msg }}</div></div>',controller:["$scope","adamaConstant",function(r,n){r.alerts=[];var o=function(t,a,n){a=a&&null!==a?a:t,r.alerts.push(e.add({type:"danger",msg:a,params:n,timeout:5e3,toast:e.isToast(),scoped:!0},r.alerts))},i=t.$on(n.appModule+".httpError",function(e,t){var r;switch(e.stopPropagation(),t.status){case 0:o("Server not reachable","error.server.not.reachable");break;case 400:var i=t.headers("X-"+n.appModule+"-error"),s=t.headers("X-"+n.appModule+"-params");if(i){var l=a.instant("global.menu.entities."+s);o(i,i,{entityName:l})}else if(t.data&&t.data.fieldErrors)for(r=0;r<t.data.fieldErrors.length;r++){var u=t.data.fieldErrors[r],c=u.field.replace(/\[\d*\]/g,"[]"),d=a.instant(n.appModule+"."+u.objectName+"."+c);o("Field "+d+" cannot be empty","error."+u.message,{fieldName:d})}else t.data&&t.data.message?o(t.data.message,t.data.message,t.data):o(t.data);break;default:o(t.data&&t.data.message?t.data.message:JSON.stringify(t))}});r.$on("$destroy",function(){void 0!==i&&null!==i&&(i(),r.alerts=[])})}]}}]),angular.module("adama-mobile").provider("AlertService",function(){var e=!1;this.$get=["$timeout","$sce","$translate",function(t,a,r){var n=0,o=[],i=5e3,s=function(){return e},l=function(){o=[]},u=function(){return o},c=function(e,t){return t.splice(e,1)},d=function(e,t){var a=t?t:o;return c(a.map(function(e){return e.id}).indexOf(e),a)},m=function(e){var t={type:e.type,msg:a.trustAsHtml(e.msg),id:e.alertId,timeout:e.timeout,toast:e.toast,position:e.position?e.position:"top right",scoped:e.scoped,close:function(e){return d(this.id,e)}};return t.scoped||o.push(t),t},p=function(e,a){e.alertId=n++,e.msg=r.instant(e.msg,e.params);var o=m(e);return e.timeout&&e.timeout>0&&t(function(){d(e.alertId,a)},e.timeout),o},g=function(t,a,r){return p({type:"success",msg:t,params:a,timeout:i,toast:e,position:r})},f=function(t,a,r){return p({type:"danger",msg:t,params:a,timeout:i,toast:e,position:r})},h=function(t,a,r){return p({type:"warning",msg:t,params:a,timeout:i,toast:e,position:r})},E=function(t,a,r){return p({type:"info",msg:t,params:a,timeout:i,toast:e,position:r})};return{factory:m,isToast:s,add:p,closeAlert:d,closeAlertByIndex:c,clear:l,get:u,success:g,error:f,info:E,warning:h}}],this.showAsToast=function(t){e=t}}),angular.module("adama-mobile").factory("User",["$resource","adamaConstant","adamaResourceConfig",function(e,t,a){var r=angular.extend({},a,{"delete":{method:"DELETE",params:{login:"@login"}}});return e(t.apiBase+"api/users/:login",{},r)}]),angular.module("adama-mobile").constant("adamaConstant",{apiBase:"http://localhost:13337/",appModule:"mySuperApp",adamaMobileToolkitTemplateUrl:{app:"adama-mobile/app.html",authAccessDenied:"adama-mobile/auth/accessDenied.html",authSignin:"adama-mobile/auth/signin.html",authRecover:"adama-mobile/auth/recoverPassword.html"},enableBadge:!1,enablePush:!1,urlResetPassword:"path/to/reset/password?isMobile=true"}),angular.module("adama-mobile").factory("adamaResourceConfig",["ParseLinks",function(e){return{query:{method:"GET",isArray:!0,transformResponse:function(t,a,r){return t=angular.fromJson(t),200===r&&(t.$metadata={links:e.parse(a("link")),totalItems:a("X-Total-Count")}),t},interceptor:{response:function(e){return e.resource.$metadata=e.data.$metadata,e.resource}}},get:{method:"GET"},save:{method:"POST"},update:{method:"PUT"},"delete":{method:"DELETE",params:{id:"@id"}}}}]),angular.module("adama-mobile").factory("adamaTokenService",["$rootScope","$http","$q","$state","$ionicUser","jwtHelper","adamaConstant",function(e,t,a,r,n,o,i){var s={},l=n.current();return e.on("principal-new",function(){l=n.current()}),s.getToken=function(){console.log("getToken");var e;return l.isAuthenticated()&&(e=l.get("access_token"),o.isTokenExpired(e))?s.refreshAndGetToken():a.when(e)},s.refreshAndGetToken=function(){var e=l.get("access_token"),a=l.get("refresh_token");return t({method:"POST",url:i.apiBase+"api/login/refresh",headers:{Authorization:"Bearer "+e},data:{refresh_token:a}}).then(function(e){var t=e.data;return l.set("access_token",t),l.save().then(function(){return t})},function(e){console.error("error while refreshing user token, redirect to signin",e),r.go("auth.signin")})},s}]),angular.module("adama-mobile").factory("authService",["$http","$ionicAuth","adamaConstant","principalService",function(e,t,a,r){var n={};return n.login=function(n,o){console.log("login",n);var i={remember:!0},s={username:n,password:o};return t.login("custom",i,s).then(function(){return console.log("login is ok, ask custom auth server to refresh the user data"),e({method:"POST",url:a.apiBase+"externalLogin/refreshUserExternal",data:{externalId:n}})}).then(function(){return console.log("refreshing custom auth server is ok, ask ionic for the updateduser info"),r.resetPrincipal()})},n.logout=function(){console.log("logout"),t.logout(),r.deletePrincipal()},n}]),angular.module("adama-mobile").factory("binaryFileService",["$http","$q","adamaConstant",function(e,t,a){var r={};return r.initUrlForBinaryFiles=function(r){var n=[],o=[];return angular.forEach(r,function(e){e&&e.id&&!e.url&&(n.push(e),o.push(e.id))}),o.length?e({method:"PUT",url:a.apiBase+"api/files",data:{idList:o}}).then(function(e){angular.forEach(n,function(t){t.url=e.data[t.id]})}):t.when()},r}]),angular.module("adama-mobile").provider("language",function(){var e=["en","fr"],t=[{code:"en",labelKey:"FLAG_EN",cssCLass:"us"},{code:"fr",labelKey:"FLAG_FR",cssCLass:"fr"}];this.setLanguages=function(t){e=t},this.setSelectorData=function(e){t=e},this.$get=["$q","$http","$translate",function(a,r,n){var o={};return o.getCurrent=function(){var e=n.storage().get("NG_TRANSLATE_LANG_KEY");return angular.isUndefined(e)&&(e="en"),a.when(e)},o.getAll=function(){return a.when(e)},o.getSelectorData=function(){return a.when(t)},o}]}),angular.module("adama-mobile").factory("pageTitle",["$rootScope","$filter",function(e,t){var a=t("translate"),r={};return r.set=function(t){var r=a(t);e.pageTitle=r},r}]),angular.module("adama-mobile").service("ParseLinks",function(){this.parse=function(e){if(0===e.length)throw new Error("input must not be of zero length");var t=e.split(","),a={};return angular.forEach(t,function(e){var t=e.split(";");if(2!==t.length)throw new Error('section could not be split on ";"');var r=t[0].replace(/<(.*)>/,"$1").trim(),n={};r.replace(new RegExp("([^?=&]+)(=([^&]*))?","g"),function(e,t,a,r){n[t]=r});var o=n.page;angular.isString(o)&&(o=parseInt(o));var i=t[1].replace(/rel='(.*)'/,"$1").trim();a[i]=o}),a}}),angular.module("adama-mobile").factory("principalService",["$rootScope","$q","$http","$resource","$ionicUser","adamaConstant",function(e,t,a,r,n,o){var i={},s=t.reject("not init"),l=!1,u=r(o.apiBase+"api/account",{},{}),c=r(o.apiBase+"api/account/change_password",{},{}),d=r(o.apiBase+"api/account/reset_password/init",{},{});return i.resetPrincipal=function(){l=!1;var r=n.current();return s=r.isAuthenticated()?a({method:"GET",url:o.apiBase+"api/users/byLogin/"+r.external_id}).then(function(t){var a=t.data;return l=!0,e.$broadcast("principal-new",{principal:a}),a}):t.reject("not logged")},i.getPrincipal=function(){return s},i.deletePrincipal=function(){l=!1,s=t.reject("not logged"),e.$broadcast("principal-remove")},i.authorize=function(){console.log("authorize")},i.hasAnyAuthority=function(e){return console.log("hasAnyAuthority",e),!0},i.resetPasswordInit=function(e){return console.log("resetPasswordInit",e),d.save({mail:e,urlResetPassword:o.urlResetPassword}).$promise},i.updateAccount=function(a){return console.log("updateAccount",a),u.save(a,function(){e.$emit("principal-update",{principal:a}),s=t.when(a)}).$promise},i.changePassword=function(e){return console.log("changePassword"),c.save({password:e}).$promise},i}]);
//# sourceMappingURL=adama-mobile-min.js.map
