"use strict";angular.module("adama-mobile",["ionic","ionic.service.core","ionic.service.auth","ionic.service.deploy","ionic.service.push","pascalprecht.translate","ngCookies","ngResource","LocalStorageModule","ngCordova","angular-jwt","angular-logger","ngMessages"]),angular.module("adama-mobile").run(["$ionicPlatform",function(e){e.ready(function(){window.cordova&&window.cordova.plugins.Keyboard&&(cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),cordova.plugins.Keyboard.disableScroll(!0)),window.StatusBar&&StatusBar.styleDefault()})}]),angular.module("adama-mobile").config(["$urlRouterProvider",function(e){e.otherwise(function(e){var a=e.get("$state");a.go("app.main")})}]),angular.module("adama-mobile").config(["$translateProvider",function(e){e.useSanitizeValueStrategy("escapeParameters"),e.useLocalStorage(),e.registerAvailableLanguageKeys(["en","fr"],{"en_*":"en","fr_*":"fr"}),e.determinePreferredLanguage().fallbackLanguage("en")}]),angular.module("adama-mobile").config(["$stateProvider","adamaConstant",function(e,a){e.state("app",{"abstract":!0,url:"/app",templateUrl:function(){return a.adamaMobileToolkitTemplateUrl.app}})}]),angular.module("adama-mobile").run(["$rootScope","pageTitle",function(e,a){e.$on("$stateChangeSuccess",function(e,t){t&&t.data&&t.data.pageTitle&&a.set(t.data.pageTitle)})}]),angular.module("adama-mobile").config(["$httpProvider",function(e){e.interceptors.push("authExpiredInterceptor"),e.interceptors.push("authInterceptor")}]),angular.module("adama-mobile").run(["$rootScope","$state","principalService",function(e,a,t){e.$on("$stateChangeStart",function(e,n){n.data&&n.data.authorities&&n.data.authorities.length>0&&(t.isAuthenticated()?t.hasAnyAuthority(n.data.authorities)||a.go("auth.accessDenied"):a.go("auth.signin"))})}]),angular.module("adama-mobile").run(["$rootScope",function(e){e.$on("$stateChangeError",function(e,a,t,n,r,o){throw o})}]),angular.module("adama-mobile").run(["$rootScope","$injector","adamaConstant",function(e,a,t){var n,r;t.enableBadge&&(n=a.get("$ionicPlatform"),r=a.get("$cordovaBadge"),n.on("resume",function(){r.clear()}),n.ready(function(){r.clear()}))}]),angular.module("adama-mobile").run(["$rootScope","$injector","$log","adamaConstant",function(e,a,t,n){var r,o,i,u=t.getInstance("adama-mobile.run.push");n.enablePush&&(r=a.get("$ionicPlatform"),o=a.get("$ionicPush"),i=a.get("$ionicUser"),r.ready(function(){o.init({debug:!1,onNotification:function(a){e.$apply(function(){var t=o.getPayload(a);u.debug("notification, payload",a,t),e.notification=a,e.payload=t,(a.app.asleep||a.app.closed)&&u.debug("application was asleep or closed")})},onRegister:function(e){u.debug("Device token",e.token)},canShowAlert:!1,canSetBadge:!0,canPlaySound:!0,canRunActionsOnWake:!0}),i.current().isAuthenticated()?o.register(function(e){u.debug("register at startup ok",e),o.saveToken(e)}):o.unregister()}),e.$on("ionicuser-new",function(){o.register(function(e){u.debug("register after signing in ok",e)})}),e.$on("principal-remove",function(){o.unregister()}))}]),angular.module("adama-mobile").config(["logEnhancerProvider",function(e){e.prefixPattern="%s::[%s]>",e.datetimePattern="DD/MM/YYYY HH:mm:ss",e.logLevels={"*":e.LEVEL.OFF}}]),angular.module("adama-mobile").controller("AccessDeniedCtrl",function(){}),angular.module("adama-mobile").config(["$stateProvider","adamaConstant",function(e,a){e.state("auth",{"abstract":!0,url:"/auth",template:"<ui-view></ui-view>"}),e.state("auth.signin",{url:"/",templateUrl:function(){return a.adamaMobileToolkitTemplateUrl.authSignin},controller:"SigninCtrl",controllerAs:"$ctrl",data:{pageTitle:"SIGNIN",authorities:[]}}),e.state("auth.recoverPassword",{url:"/recoverPassword",templateUrl:function(){return a.adamaMobileToolkitTemplateUrl.authRecover},controller:"RecoverPasswordCtrl",controllerAs:"$ctrl",data:{pageTitle:"RECOVER",authorities:[]}}),e.state("auth.accessDenied",{url:"/accessDenied",templateUrl:function(){return a.adamaMobileToolkitTemplateUrl.authAccessDenied},controller:"AccessDeniedCtrl",controllerAs:"$ctrl",data:{pageTitle:"ACCESS_DENIED",authorities:[]}})}]),angular.module("adama-mobile").config(["$translateProvider",function(e){e.translations("fr",{SIGNIN:"Identification",SIGNIN_INTRO:"Identifiez-vous pour démarrer votre session",SIGNIN_FORGET_PASSWORD:"J'ai oublié mon mot de passe ...",SIGNIN_USERNAME:"Identifiant",SIGNIN_USERNAME_REQUIRED:"L'identifiant est obligatoire",SIGNIN_PASSWORD:"Mot de passe",SIGNIN_PASSWORD_REQUIRED:"Le mot de passe est obligatoire",SIGNIN_SUBMIT:"Démarrer la session",SIGNIN_LOADING:"Données en cours de chargement",SIGNIN_ERROR_TITLE:"Erreur d'authentification",SIGNIN_ERROR_MESSAGE:"Identifiant ou mot de passe incorrect.",RECOVER:"Récupération de mot de passe",RECOVER_INTRO:"Saisissez votre email pour récupérer votre mot de passe",RECOVER_MAIL:"Email",RECOVER_MAIL_REQUIRED:"L'email est obligatoire",RECOVER_MAIL_EMAIL:"L'email n'est pas au bon format",RECOVER_SUBMIT:"Récupérer mon mot de passe",RECOVER_BACK_TO_LOGIN:"Retour à l'identificaition",RECOVER_SUCCESS:"Consultez votre email pour connaître comment réinitialiser votre mot de passe.",RECOVER_ERROR_TITLE:"Erreur",RECOVER_ERROR_GENERIC:"Erreur lors de la récupération du mot de passe.",RECOVER_ERROR_EMAIL_NOT_EXIST:"L'email n'existe pas",ACCESS_DENIED_BACK_TO_HOME:"Retour à l'accueil",ACCESS_DENIED:"Accès interdit",ACCESS_DENIED_INTRO:"Vous n'avez pas suffisamment de droits d'accéder à cette page."}),e.translations("en",{SIGNIN:"Signin",SIGNIN_INTRO:"Sign in to start your session",SIGNIN_FORGET_PASSWORD:"I forgot my password ...",SIGNIN_USERNAME:"Username",SIGNIN_USERNAME_REQUIRED:"Username is required",SIGNIN_PASSWORD:"Password",SIGNIN_PASSWORD_REQUIRED:"Password is required",SIGNIN_SUBMIT:"Start session",SIGNIN_LOADING:"Loading user informations",SIGNIN_ERROR_TITLE:"Authentication error",SIGNIN_ERROR_MESSAGE:"Username or password are incorrect.",RECOVER:"Recover password",RECOVER_INTRO:"Set your email to recover your password",RECOVER_MAIL:"Email",RECOVER_MAIL_REQUIRED:"Email is required",RECOVER_MAIL_EMAIL:"Email does not respect the right format",RECOVER_SUBMIT:"Retrieve my password",RECOVER_BACK_TO_LOGIN:"Back to signin",RECOVER_SUCCESS:"Check your e-mails for details on how to reset your password.",RECOVER_ERROR_TITLE:"Error",RECOVER_ERROR_GENERIC:"Recovering error.",RECOVER_ERROR_EMAIL_NOT_EXIST:"E-Mail address isn't registered! Please check and try again",ACCESS_DENIED_BACK_TO_HOME:"Back to home",ACCESS_DENIED:"Access denied",ACCESS_DENIED_INTRO:"You do not have enough privileges to access this page."})}]),angular.module("adama-mobile").controller("RecoverPasswordCtrl",["$filter","$ionicPopup","principalService",function(e,a,t){var n=this;n.recover=function(r){n.recoverSuccess=!1,n.recoverError=!1,n.errorEmailNotExists=!1,n.loading=!0,t.resetPasswordInit(r).then(function(){n.recoverSuccess=!0})["catch"](function(t){var n="RECOVER_ERROR_GENERIC";400===t.status&&"e-mail address not registered"===t.data&&(n="RECOVER_ERROR_EMAIL_NOT_EXIST");var r=e("translate");a.alert({title:r("RECOVER_ERROR_TITLE"),template:r(n)})})["finally"](function(){n.loading=!1})}}]),angular.module("adama-mobile").controller("SigninCtrl",["$rootScope","$state","$log","authService","$filter","$ionicPopup",function(e,a,t,n,r,o){var i=t.getInstance("adama-mobile.auth.signin"),u=this;u.loading=!1,u.signin=function(e,t){u.loading=!0,n.login(e,t).then(function(){i.debug("user is logged, rediret to app.main"),a.go("app.main"),u.loading=!1})["catch"](function(e){i.info("error while signing in",e),u.rejection=e;var a=r("translate");o.alert({title:a("SIGNIN_ERROR_TITLE"),template:a("SIGNIN_ERROR_MESSAGE")}),u.loading=!1})}}]),angular.module("adama-mobile").config(["$translateProvider",function(e){e.translations("fr",{BTN_SIGNOUT:"Déconnexion"}),e.translations("en",{BTN_SIGNOUT:"Sign out"})}]),angular.module("adama-mobile").component("btnSignout",{templateUrl:"adama-mobile/btn-signout/btn-signout.html",controller:["authService","$state",function(e,a){var t=this;t.signout=function(){e.logout(),a.go("auth.signin")}}]}),angular.module("adama-mobile").directive("dsBinaryFileUrl",["$parse","binaryFileService",function(e,a){return{scope:!1,link:function(t,n,r){var o=function(n){r.output&&(n=angular.copy(n)),angular.isArray(n)||(n=[n]),a.initUrlForBinaryFiles(n).then(function(){r.output&&e(r.output).assign(t,n)})};t.$watch(r.input,function(){var a=e(r.input)(t);a&&o(a)})}}}]),angular.module("adama-mobile").directive("dsLanguage",["$parse","language",function(e,a){return{scope:!1,link:function(t,n,r){a.getAll().then(function(a){e(r.data).assign(t,a)})}}}]),angular.module("adama-mobile").directive("dsPrincipalIdentity",["$rootScope","$parse","principalService",function(e,a,t){return{scope:!1,link:function(n,r,o){e.$on("principal-new",function(e,t){a(o.data).assign(n,t.principal)}),e.$on("principal-remove",function(){a(o.data).assign(n,void 0)}),t.getPrincipal().then(function(e){a(o.data).assign(n,e)})}}}]),angular.module("adama-mobile").factory("authExpiredInterceptor",["$injector","$q","$log","adamaConstant",function(e,a,t,n){var r=function(){var a;return function(){return a||(a=e.get("$http"))}}(),o=function(){var a;return function(){return a||(a=e.get("adamaTokenService"))}}(),i=function(){var a;return function(){return a||(a=e.get("$state"))}}();return{responseError:function(e){var u=e.config;if(401===e.status&&0===u.url.indexOf(n.apiBase)){var s=t.getInstance("adama-mobile.interceptors.authExpiredInterceptor");return s.debug("error 401, refresh token",u.url),o().refreshAndGetToken().then(function(){return s.debug("token is refresh, reset Authorization header"),u.headers.Authorization=void 0,r()(u)},function(e){return i().go("auth.signin").then(function(){return s.debug("error while getting user token",e),a.reject(e)})})}return a.reject(e)}}}]),angular.module("adama-mobile").factory("authInterceptor",["$injector","$q","$log","adamaConstant",function(e,a,t,n){var r=function(){var a;return function(){return a||(a=e.get("adamaTokenService"))}}(),o=function(){var a;return function(){return a||(a=e.get("$state"))}}();return{request:function(e){var i=t.getInstance("adama-mobile.interceptors.authInterceptor");return i.debug("url",e.url),e.headers=e.headers||{},e.headers.Authorization||0!==e.url.indexOf(n.apiBase)?e:(i.debug("need authorization, getting token"),r().getToken().then(function(a){return i.debug("adding Authorization header",a),a&&(e.headers.Authorization="Bearer "+a),e},function(e){return o().go("auth.signin").then(function(){return i.debug("error while getting user token",e),a.reject(e)})}))}}}]),angular.module("adama-mobile").factory("User",["$resource","adamaConstant","adamaResourceConfig",function(e,a,t){var n=angular.extend({},t,{"delete":{method:"DELETE",params:{id:"@id"}}});return e(a.apiBase+"users/:id",{},n)}]),angular.module("adama-mobile").factory("adamaResourceConfig",["ParseLinks",function(e){return{query:{method:"GET",isArray:!0,transformResponse:function(a,t,n){return a=angular.fromJson(a),200===n&&(a.$metadata={links:e.parse(t("link")),totalItems:t("X-Total-Count")}),a},interceptor:{response:function(e){return e.resource.$metadata=e.data.$metadata,e.resource}}},get:{method:"GET"},save:{method:"POST"},update:{method:"PUT"},"delete":{method:"DELETE",params:{id:"@id"}}}}]),angular.module("adama-mobile").factory("adamaTokenService",["$rootScope","$http","$q","$state","$ionicUser","$log","jwtHelper","adamaConstant",function(e,a,t,n,r,o,i,u){var s=o.getInstance("adama-mobile.services.adamaTokenService"),c={},l=r.current();return e.$on("ionicuser-new",function(){s.debug("adamaTokenService update ionicUser"),l=r.current()}),c.getToken=function(){s.debug("adamaTokenService.getToken");var e;return l.isAuthenticated()&&(s.debug("adamaTokenService.getToken user is authenticated"),e=l.get("access_token"),e&&i.isTokenExpired(e))?(s.debug("adamaTokenService.getToken token is expired"),c.refreshAndGetToken()):t.when(e)},c.refreshAndGetToken=function(){s.debug("adamaTokenService.refreshAndGetToken");var e=l.get("access_token");if(!e)return s.info("no token, redirect to signin"),s.debug("for debugging purpose, here is the ionic current user",l),s.debug("for debugging purpose, here is the ionic current user.isAuthenticated",l.isAuthenticated()),s.debug("for debugging purpose, here is a JSON.stringify version of ionic current user",JSON.stringify(l)),t.reject("refreshAndGetToken : no token !!!!");s.debug("adamaTokenService.refreshAndGetToken token",e);var n=l.get("refresh_token");return s.debug("adamaTokenService.refreshAndGetToken refreshToken",n),a({method:"POST",url:u.apiBase+"login/refresh",headers:{Authorization:"Bearer "+e},data:{refresh_token:n}}).then(function(e){var a=e.data.access_token;return s.debug("adamaTokenService.refreshAndGetToken newToken",a),l.set("access_token",a),l.save().then(function(){return a})},function(e){return s.info("error while refreshing user token, redirect to signin",e),t.reject(e)})},c}]),angular.module("adama-mobile").constant("adamaConstant",{apiBase:"http://localhost:13337/",adamaMobileToolkitTemplateUrl:{app:"adama-mobile/app.html",authAccessDenied:"adama-mobile/auth/accessDenied.html",authSignin:"adama-mobile/auth/signin.html",authRecover:"adama-mobile/auth/recoverPassword.html"},enableBadge:!1,enablePush:!1,urlResetPassword:"path/to/reset/password?origin=mobile"}),angular.module("adama-mobile").factory("authService",["$rootScope","$http","$ionicAuth","$log","adamaConstant","principalService",function(e,a,t,n,r,o){var i=n.getInstance("adama-mobile.services.authService"),u={};return u.login=function(n,u){i.debug("login",n);var s={remember:!0},c={username:n,password:u};return t.login("custom",s,c).then(function(){return i.debug("login is ok, ask custom auth server to refresh the user data"),a({method:"POST",url:r.apiBase+"externalLogin/refreshUserExternal",data:{externalId:n}})}).then(function(){return i.debug("refreshing custom auth server is ok, ask the backend for the updated user info"),e.$broadcast("ionicuser-new"),o.resetPrincipal()}).then(function(){i.debug("user is logged in in both ionic and backend")})},u.logout=function(){i.debug("logout"),t.logout(),o.deletePrincipal()},u}]),angular.module("adama-mobile").factory("binaryFileService",["$http","$q","adamaConstant",function(e,a,t){var n={};return n.initUrlForBinaryFiles=function(n){var r=[],o=[];return angular.forEach(n,function(e){e&&e.id&&!e.url&&(r.push(e),o.push(e.id))}),o.length?e({method:"PUT",url:t.apiBase+"files",data:angular.toJson(o)}).then(function(e){angular.forEach(r,function(a){a.url=e.data.urlList[a.id]})}):a.when()},n}]),angular.module("adama-mobile").provider("language",function(){var e=["en","fr"],a=[{code:"en",labelKey:"FLAG_EN",cssCLass:"us"},{code:"fr",labelKey:"FLAG_FR",cssCLass:"fr"}];this.setLanguages=function(a){e=a},this.setSelectorData=function(e){a=e},this.$get=["$q","$http","$translate",function(t,n,r){var o={};return o.getCurrent=function(){var e=r.storage().get("NG_TRANSLATE_LANG_KEY");return angular.isUndefined(e)&&(e="en"),t.when(e)},o.getAll=function(){return t.when(e)},o.getSelectorData=function(){return t.when(a)},o}]}),angular.module("adama-mobile").factory("loadingService",["$filter","$ionicLoading",function(e,a){var t={},n=e("translate");return t.blockUiWhileResolving=function(e,t){return 0===t.$$state.status&&a.show({template:n(e)}),t["finally"](function(){a.hide()})},t}]),angular.module("adama-mobile").factory("notificationsService",["$filter","$cordovaToast","$log",function(e,a,t){var n=t.getInstance("adama-mobile.services.notificationsService"),r={},o=e("translate");return r.show=function(e){return n.debug("notifications show",e),a.show(o(e),"short","bottom")},r}]),angular.module("adama-mobile").factory("pageTitle",["$rootScope","$filter",function(e,a){var t=a("translate"),n={};return n.set=function(a,n){var r=t(a,n);e.pageTitle=r},n}]),angular.module("adama-mobile").service("ParseLinks",function(){this.parse=function(e){if(0===e.length)throw new Error("input must not be of zero length");var a=e.split(","),t={};return angular.forEach(a,function(e){var a=e.split(";");if(2!==a.length)throw new Error('section could not be split on ";"');var n=a[0].replace(/<(.*)>/,"$1").trim(),r={};n.replace(new RegExp("([^?=&]+)(=([^&]*))?","g"),function(e,a,t,n){r[a]=n});var o=r.page;angular.isString(o)&&(o=parseInt(o));var i=a[1].replace(/rel='(.*)'/,"$1").trim();t[i]=o}),t}}),angular.module("adama-mobile").factory("principalService",["$rootScope","$q","$http","$resource","$state","$ionicUser","$log","adamaConstant",function(e,a,t,n,r,o,i,u){var s,c=i.getInstance("adama-mobile.services.principalService"),l={},d=o.current(),g=d.isAuthenticated(),m=n(u.apiBase+"account",{},{}),f=n(u.apiBase+"account/change_password",{},{}),p=n(u.apiBase+"account/reset_password/init",{},{});return l.isAuthenticated=function(){return g},l.resetPrincipal=function(){var n;if(d=o.current(),g=d.isAuthenticated(),c.debug("resetPrincipal"),c.debug("resetPrincipal ionicUser",d),c.debug("resetPrincipal isAuthenticated",g),g){var i=d.details.external_id;i?(s=t({method:"GET",url:u.apiBase+"users/byLogin/"+i}).then(function(a){var t=a.data;return g=!0,e.$broadcast("principal-new",{principal:t}),t}),n=s):(c.info("no external_id, redirect to signin"),n=a.reject("resetPrincipal : no external_id"))}else c.info("user is not authenticated"),n=a.reject("resetPrincipal : not authenticated");return n["catch"](function(e){return c.debug("there was a problem while reseting user info, redirect to signin"),g=!1,s=void 0,r.go("auth.signin"),a.reject(e)})},l.getPrincipal=function(){return s?s:l.resetPrincipal()},l.deletePrincipal=function(){g=!1,s=void 0,e.$broadcast("principal-remove")},l.hasAnyAuthority=function(e){return c.debug("hasAnyAuthority",e),!0},l.resetPasswordInit=function(e){return c.debug("resetPasswordInit",e),p.save({mail:e,urlResetPassword:u.urlResetPassword}).$promise},l.updateAccount=function(t){return c.debug("updateAccount",t),m.save(t,function(){e.$emit("principal-update",{principal:t}),s=a.when(t)}).$promise},l.changePassword=function(e){return c.debug("changePassword"),f.save({password:e}).$promise},l}]);
//# sourceMappingURL=adama-mobile-min.js.map
